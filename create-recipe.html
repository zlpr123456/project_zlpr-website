<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºé£Ÿè°± - çº¸ä¸Šæ»‘é›ªçš„å®¶åº­é£Ÿè°±</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="recipe-styles.css">
    <style>
        /* ç”¨æˆ·ä¿¡æ¯æ ·å¼ */
        .main-nav {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .username {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .logout-btn {
            font-size: 12px;
            padding: 6px 12px;
        }

        @media (max-width: 768px) {
            .main-nav {
                flex-wrap: wrap;
            }

            .user-info {
                margin-left: 0;
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸš€ çº¸ä¸Šæ»‘é›ªçš„æ‚ç‰©é—´</h1>
            <p class="subtitle">é«˜è´¨é‡å·¥å…·å’Œè½¯ä»¶ä¸‹è½½å¹³å°</p>
            <nav class="main-nav">
                <a href="index.html" class="nav-link">ğŸ  é¦–é¡µ</a>
                <a href="recipes.html" class="nav-link">ğŸ³ å®¶åº­é£Ÿè°±</a>
                <div class="user-info" id="userInfo">
                    <!-- ç™»å½•åæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å’Œé€€å‡ºæŒ‰é’® -->
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <section class="recipe-sub-nav">
            <a href="recipes.html" class="sub-nav-link">ğŸ“– é£Ÿè°±åˆ—è¡¨</a>
            <a href="create-recipe.html" class="sub-nav-link active">â• åˆ›å»ºé£Ÿè°±</a>
            <a href="favorites.html" class="sub-nav-link">â­ æˆ‘çš„æ”¶è—</a>
        </section>

        <div class="recipe-form-container">
            <h1 id="formTitle">åˆ›å»ºæ–°é£Ÿè°±</h1>
            
            <form id="recipeForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="recipeId" name="id">

                <div class="form-section">
                    <h2>åŸºæœ¬ä¿¡æ¯</h2>
                    <div class="form-group">
                        <label for="title">é£Ÿè°±æ ‡é¢˜ *</label>
                        <input type="text" id="title" name="title" required placeholder="ä¾‹å¦‚ï¼šçº¢çƒ§è‚‰">
                    </div>

                    <div class="form-group">
                        <label for="description">æè¿°</label>
                        <textarea id="description" name="description" rows="3" placeholder="ç®€å•æè¿°è¿™é“èœ..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cooking_time">çƒ¹é¥ªæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" id="cooking_time" name="cooking_time" min="1" placeholder="ä¾‹å¦‚ï¼š60">
                        </div>
                        <div class="form-group">
                            <label for="servings">ä»½é‡ï¼ˆäººä»½ï¼‰</label>
                            <input type="number" id="servings" name="servings" min="1" placeholder="ä¾‹å¦‚ï¼š4">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="difficulty">éš¾åº¦</label>
                            <select id="difficulty" name="difficulty">
                                <option value="ç®€å•">ç®€å•</option>
                                <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                                <option value="å›°éš¾">å›°éš¾</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="category">åˆ†ç±»</label>
                            <select id="category" name="category">
                                <option value="">é€‰æ‹©åˆ†ç±»</option>
                                <option value="å®¶å¸¸èœ">å®¶å¸¸èœ</option>
                                <option value="ç”œç‚¹">ç”œç‚¹</option>
                                <option value="æ±¤å“">æ±¤å“</option>
                                <option value="ä¸»é£Ÿ">ä¸»é£Ÿ</option>
                                <option value="å‡‰èœ">å‡‰èœ</option>
                                <option value="é¥®å“">é¥®å“</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tags">æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                        <input type="text" id="tags" name="tags" placeholder="ä¾‹å¦‚ï¼šçŒªè‚‰,ä¸‹é¥­èœ,å®¶å¸¸">
                    </div>
                </div>

                <div class="form-section">
                    <h2>æ‰€éœ€é£Ÿæ</h2>
                    <div class="form-group">
                        <label for="ingredients">é£Ÿæåˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰*</label>
                        <textarea id="ingredients" name="ingredients" rows="8" required placeholder="ä¾‹å¦‚ï¼š&#10;äº”èŠ±è‚‰ 500g&#10;ç”ŸæŠ½ 2å‹º&#10;è€æŠ½ 1å‹º&#10;å†°ç³– 30g"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h2>åˆ¶ä½œæ­¥éª¤</h2>
                    <div class="form-group">
                        <label for="instructions">åˆ¶ä½œæ­¥éª¤ï¼ˆæ¯è¡Œä¸€ä¸ªæ­¥éª¤ï¼‰*</label>
                        <textarea id="instructions" name="instructions" rows="10" required placeholder="ä¾‹å¦‚ï¼š&#10;1. äº”èŠ±è‚‰åˆ‡æˆ2cmè§æ–¹çš„å—&#10;2. å†·æ°´ä¸‹é”…ç„¯æ°´ï¼Œæå‡ºæ´—å‡€&#10;3. çƒ­é”…å†·æ²¹ï¼Œä¸‹å†°ç³–ç‚’ç³–è‰²&#10;4. ä¸‹è‚‰å—ç¿»ç‚’ä¸Šè‰²"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h2>ä¸Šä¼ å›¾ç‰‡</h2>
                    <div class="form-group">
                        <label for="images">é€‰æ‹©å›¾ç‰‡ï¼ˆå¯å¤šé€‰ï¼‰</label>
                        <input type="file" id="images" name="images" multiple accept="image/jpeg,image/png,image/gif,image/webp" onchange="handleImageSelect(event)">
                        <p class="form-hint">æ”¯æŒ JPGã€PNGã€GIFã€WebP æ ¼å¼ï¼Œå•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡5MB</p>
                    </div>

                    <div id="imagePreview" class="image-preview"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜é£Ÿè°±</button>
                    <button type="button" onclick="window.location.href='recipes.html'" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2026 çº¸ä¸Šæ»‘é›ªçš„å®¶åº­é£Ÿè°±. All rights reserved.</p>
        </div>
    </footer>

    <script src="recipe-api.js"></script>
    <script>
        // ç¡®ä¿deleteRecipeImageå‡½æ•°å¯ç”¨
        if (typeof deleteRecipeImage === 'undefined') {
            async function deleteRecipeImage(recipeId, imageId) {
                const API_BASE = '/api';
                
                const response = await fetch(`${API_BASE}/recipes/${recipeId}/images/${imageId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    try {
                        const error = await response.json();
                        throw new Error(error.error || 'è¯·æ±‚å¤±è´¥');
                    } catch (jsonError) {
                        throw new Error('è¯·æ±‚å¤±è´¥: ' + response.statusText);
                    }
                }
                
                return true;
            }
        }
        
        let selectedImages = [];
        let editingRecipeId = null;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLogin() {
            const user = localStorage.getItem('recipe_user');
            if (!user) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        async function generateThumbnail(file, maxWidth = 300, maxHeight = 300, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = Math.round(width * ratio);
                        height = Math.round(height * ratio);
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        if (blob) {
                            resolve(new File([blob], `thumb_${file.name}`, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            }));
                        } else {
                            reject(new Error('Failed to generate thumbnail'));
                        }
                    }, 'image/jpeg', quality);
                };
                
                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = URL.createObjectURL(file);
            });
        }

        async function loadRecipeForEdit() {
            if (!checkLogin()) return;
            
            const params = new URLSearchParams(window.location.search);
            const recipeId = params.get('id');
            
            if (recipeId) {
                editingRecipeId = recipeId;
                document.getElementById('formTitle').textContent = 'ç¼–è¾‘é£Ÿè°±';
                document.getElementById('recipeId').value = recipeId;

                try {
                    const recipe = await getRecipeById(recipeId);
                    document.getElementById('title').value = recipe.title;
                    document.getElementById('description').value = recipe.description || '';
                    document.getElementById('cooking_time').value = recipe.cooking_time || '';
                    document.getElementById('servings').value = recipe.servings || '';
                    document.getElementById('difficulty').value = recipe.difficulty;
                    document.getElementById('category').value = recipe.category || '';
                    document.getElementById('tags').value = recipe.tags || '';
                    document.getElementById('ingredients').value = recipe.ingredients;
                    document.getElementById('instructions').value = recipe.instructions;

                    const images = await getRecipeImages(recipeId);
                    if (images.length > 0) {
                        images.forEach(img => {
                            selectedImages.push({
                                id: img.id,
                                file: null,
                                url: img.r2_url,
                                isCover: img.is_cover
                            });
                        });
                        updateImagePreview();
                    }
                } catch (error) {
                    console.error('åŠ è½½é£Ÿè°±å¤±è´¥:', error);
                    alert('åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
                }
            }
        }

        async function handleImageSelect(event) {
            if (!checkLogin()) return;
            
            const files = Array.from(event.target.files);
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`æ–‡ä»¶ ${file.name} è¶…è¿‡5MBï¼Œè¯·é€‰æ‹©æ›´å°çš„æ–‡ä»¶`);
                    continue;
                }
                
                if (!allowedTypes.includes(file.type)) {
                    alert(`æ–‡ä»¶ ${file.name} æ ¼å¼ä¸æ”¯æŒï¼Œè¯·é€‰æ‹© JPGã€PNGã€GIF æˆ– WebP æ ¼å¼çš„å›¾ç‰‡`);
                    continue;
                }
                
                try {
                    const thumbnail = await generateThumbnail(file);
                    selectedImages.push({
                        file: file,
                        thumbnail: thumbnail,
                        url: URL.createObjectURL(file),
                        isCover: selectedImages.length === 0
                    });
                } catch (error) {
                    console.error('ç”Ÿæˆç¼©ç•¥å›¾å¤±è´¥:', error);
                    selectedImages.push({
                        file: file,
                        thumbnail: null,
                        url: URL.createObjectURL(file),
                        isCover: selectedImages.length === 0
                    });
                }
            }

            updateImagePreview();
            event.target.value = '';
        }

        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            
            if (selectedImages.length === 0) {
                preview.innerHTML = '<p class="no-images">æš‚æ— å›¾ç‰‡</p>';
                return;
            }

            preview.innerHTML = selectedImages.map((img, index) => `
                <div class="preview-item ${img.isCover ? 'cover' : ''}">
                    <img src="${img.url}" alt="é¢„è§ˆå›¾">
                    <div class="preview-actions">
                        ${img.isCover ? '<span class="cover-badge">å°é¢</span>' : 
                            `<button type="button" onclick="setCover(${index})" class="btn btn-small">è®¾ä¸ºå°é¢</button>`}
                        <button type="button" onclick="removeImage(${index})" class="btn btn-small btn-danger">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function setCover(index) {
            if (!checkLogin()) return;
            
            selectedImages.forEach((img, i) => {
                img.isCover = i === index;
            });
            updateImagePreview();
        }

        async function removeImage(index) {
            if (!checkLogin()) return;
            
            const img = selectedImages[index];
            
            if (img.id && editingRecipeId) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
                    try {
                        await deleteRecipeImage(editingRecipeId, img.id);
                    } catch (error) {
                        console.error('åˆ é™¤å›¾ç‰‡å¤±è´¥:', error);
                        alert('åˆ é™¤å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
                        return;
                    }
                } else {
                    return;
                }
            }
            
            selectedImages.splice(index, 1);
            if (selectedImages.length > 0 && !selectedImages.some(img => img.isCover)) {
                selectedImages[0].isCover = true;
            }
            updateImagePreview();
        }

        async function handleSubmit(event) {
            if (!checkLogin()) return;
            
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const recipeData = {
                title: formData.get('title'),
                description: formData.get('description'),
                cooking_time: formData.get('cooking_time') ? parseInt(formData.get('cooking_time')) : null,
                servings: formData.get('servings') ? parseInt(formData.get('servings')) : null,
                difficulty: formData.get('difficulty'),
                category: formData.get('category'),
                tags: formData.get('tags'),
                ingredients: formData.get('ingredients'),
                instructions: formData.get('instructions')
            };

            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ä¿å­˜ä¸­...';

            try {
                let recipeId;
                if (editingRecipeId) {
                    recipeId = await updateRecipeAPI(editingRecipeId, recipeData);
                } else {
                    recipeId = await createRecipeAPI(recipeData);
                }

                if (selectedImages.length > 0) {
                    const newImages = selectedImages.filter(img => img.file);
                    const totalImages = newImages.length;
                    
                    for (let i = 0; i < newImages.length; i++) {
                        const img = newImages[i];
                        const progress = (i / totalImages) * 100;
                        
                        await uploadRecipeImage(recipeId, img.file, img.isCover, img.thumbnail, (percent) => {
                            const currentProgress = progress + (percent / totalImages);
                            submitBtn.textContent = `ä¸Šä¼ ä¸­ ${Math.round(currentProgress)}%`;
                        });
                    }
                }

                submitBtn.textContent = '100%';
                setTimeout(() => {
                    alert('ä¿å­˜æˆåŠŸï¼');
                    window.location.href = `recipe-detail.html?id=${recipeId}`;
                }, 500);
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                // æ˜¾ç¤ºå…·ä½“çš„é”™è¯¯ä¿¡æ¯
                const errorMessage = error.message || 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•';
                alert(`ä¿å­˜å¤±è´¥ï¼š${errorMessage}`);
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ’¾ ä¿å­˜é£Ÿè°±';
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function showUserInfo() {
            const userInfoElement = document.getElementById('userInfo');
            const user = localStorage.getItem('recipe_user');
            
            if (user) {
                const userObj = JSON.parse(user);
                userInfoElement.innerHTML = `
                    <span class="username">ğŸ‘¤ ${userObj.username}</span>
                    <button onclick="logout()" class="btn btn-secondary logout-btn">ğŸšª é€€å‡º</button>
                `;
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('recipe_user');
            localStorage.removeItem('recipe_token');
            window.location.href = 'login.html';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            if (checkLogin()) {
                showUserInfo();
                loadRecipeForEdit();
            }
        };
    </script>
</body>
</html>